# Redis 기반 선착순 쿠폰 발급 시스템

선착순 쿠폰 발급 기능에 대해 Redis 기반의 설계를 진행하고, 적절하게 동작할 수 있도록 쿠폰 발급 로직을 구현합니다.

<br/>

## 📚 목차

- [1. 배경](#1-배경)
- [2. 문제 해결](#2-문제-해결)
- [3. 설계](#3-설계)
- [4. 구현](#4-구현)
- [5. 한계점](#5-한계점)
- [6. 개선 사항](#6-개선-사항)
- [7. 결론](#7-결론)

<br/>


## 1. 배경

이커머스 서비스에서는 **선착순 쿠폰 발급**과 같은 이벤트성 프로모션을 제공해야 합니다.

사용자 경험을 위해 쿠폰 요청이 들어오는 즉시 발급 여부를 판단하고, **한 유저당 한 번만 발급**하는 조건을 만족해야 하며, 동시에 **초당 수천~수만 건의 요청**에도 안정적으로 처리할 수 있어야 합니다.

기존 시스템은 RDBMS 기반 동기 처리 구조로 구현되어, 대량 요청 시 트랜잭션 충돌과 DB 부하가 발생할 수 있는 문제가 있습니다. 이러한 한계를 극복하고 비즈니스 요구사항을 안정적으로 충족하기 위해 Redis 기반 비동기 구조로 전환할 필요가 있습니다.

<br/>

<br/>

## 2. 문제 해결

- **Redis 필터링**: 쿠폰 수량 관리(String DECR)와 중복 발급 방지(Set)를 Redis에서 처리하여 DB 접근 최소화
- **대기열 처리**: Sorted Set을 활용해 요청 순서를 관리하고, 비동기 스케줄러를 통해 DB에 쿠폰 발급 내역 반영
- **비즈니스 로직 추상화**: CouponMemoryRepository 인터페이스를 통해 Redis 구현체와 서비스 로직 분리 → 인프라 변경에도 서비스 보호
- **원자성 및 동시성 보장**: Redis 원자 연산을 활용하여 대량 동시 요청 시에도 선착순 규칙과 발급 제한을 안정적으로 적용

<br/>

<br/>

## 3. 설계

### 3.1 핵심 구성

기능 | Redis 자료구조 | Key 전략 | 설명
-- | -- | -- | --
쿠폰 수량 관리 | String | coupon:{policyId}:stock | DECR 연산으로 원자적 재고 차감
중복 발급 방지 | Set | coupon:{policyId}:users | userId 저장, 이미 발급된 유저 체크
대기열 관리 | Sorted Set | coupon:{policyId}:queue | score = 요청 시간, DB 반영 전 대기열 역할


<br/>

### 3.2 처리 흐름

1. **쿠폰 요청 시 Redis 필터링**
    - 중복 발급 확인(Set)
    - 수량 확인(DECR)
    - Redis 필터 통과 시 대기열(Sorted Set)에 enqueue
2. **DB 반영 스케줄러 (Scheduled Job**
    - 일정 간격(5초)으로 대기열 조회
    - DB에 쿠폰 발급 내역 저장
    - 대기열에서 제거
3. **응답 전략**
    - Redis 검증 성공 시 바로 성공 응답
    - DB 반영은 비동기 처리

<br/>

<br/>

## 4. 구현

- **RedisTemplate** 사용: String, Set, Sorted Set 활용
- **Repository 추상화**
    - `CouponMemoryRepository` : 쿠폰 발급 정책 인터페이스 추상화
    - `CouponRedisRepository` : Redis 구현체, 내부에서 Redis 연산 수행
- **Service 레이어 역할**
    - `issueCoupon(userId, policyId)` : Redis 필터 + 대기열 enqueue
- **Batch 처리**
    - `CouponQueueScheduler` : 대기열에서 일정 수량 dequeue 후 DB 저장

<br/>

<br/>

## 5. 한계점

- Redis 단일 장애 시 **발급 대기열 데이터 손실 가능**
- 대량 동시 요청 시 Sorted Set 처리 속도 제한 가능
- DB와 Redis 간의 **일관성 지연** 발생 가능

<br/>

<br/>

## 6. 개선 사항

- Redis Cluster 및 Replica를 활용해 장애 대비
- 배치 주기 및 처리량 튜닝으로 대량 요청 대응 최적화
- DB 반영 성공/실패 로그를 별도 테이블에 기록하여 재처리 가능하게 구성

<br/>

<br/>

## 7. 결론

- Redis 기반 비동기 구조를 통해 **DB 부하 최소화 및 초당 대량 요청 처리 가능**
- 쿠폰 발급 정책 인터페이스 추상화로 서비스 로직과 인프라 분리
- 선착순, 한 유저당 한 번 발급 요구사항을 안정적으로 만족